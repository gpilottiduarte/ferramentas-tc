<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Analisador de Documentos por Persona</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --primary: #f5f7fa;
      --secondary: #e3e8ee;
      --accent: #4f8cff;
      --text: #222;
      --border: #d1d9e6;
      --radius: 10px;
      --shadow: 0 2px 8px rgba(80, 120, 200, 0.07);
    }
    body {
      background: var(--primary);
      color: var(--text);
      font-family: 'Segoe UI', 'Arial', sans-serif;
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .container {
      background: #fff;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 2.5rem 2rem 2rem 2rem;
      max-width: 430px;
      width: 100%;
      margin: 2rem;
      border: 1px solid var(--border);
    }
    h1 {
      font-size: 1.5rem;
      margin-bottom: 1.2rem;
      color: var(--accent);
      text-align: center;
      font-weight: 600;
    }
    label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }
    input[type="file"], select, input[type="password"], input[type="text"] {
      width: 100%;
      padding: 0.6rem;
      margin-bottom: 1.2rem;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--secondary);
      font-size: 1rem;
      box-sizing: border-box;
      transition: border 0.2s;
    }
    input[type="file"] {
      padding: 0.3rem;
    }
    input[type="password"], input[type="text"] {
      letter-spacing: 0.05em;
    }
    select:focus, input:focus {
      border-color: var(--accent);
      outline: none;
    }
    button {
      width: 100%;
      padding: 0.8rem;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: var(--radius);
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 1px 4px rgba(80, 120, 200, 0.08);
      transition: background 0.2s;
    }
    button:disabled {
      background: #b3cfff;
      cursor: not-allowed;
    }
    .result {
      margin-top: 1.5rem;
      background: var(--secondary);
      border-radius: var(--radius);
      padding: 1.2rem;
      min-height: 80px;
      font-size: 1rem;
      white-space: pre-line;
      border: 1px solid var(--border);
      color: #2a2a2a;
    }
    .api-key-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1.2rem;
    }
    .api-key-row input {
      flex: 1;
      margin-bottom: 0;
    }
    .api-key-row button {
      width: auto;
      padding: 0.6rem 1rem;
      font-size: 0.95rem;
      background: #e3e8ee;
      color: var(--accent);
      border: 1px solid var(--border);
      font-weight: 500;
      box-shadow: none;
    }
    .api-key-row button:disabled {
      color: #aaa;
      background: #f5f7fa;
      border-color: #eee;
    }
    .loading {
      text-align: center;
      color: var(--accent);
      font-weight: 500;
      margin-top: 1rem;
    }
    @media (max-width: 600px) {
      .container {
        padding: 1.2rem 0.5rem;
        max-width: 98vw;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Analisador de Documentos por Persona</h1>
    <form id="analyzer-form">
      <label for="file">Documento (PDF, TXT ou MD):</label>
      <input type="file" id="file" accept=".pdf,.txt,.md" required />

      <label for="persona">Persona:</label>
      <select id="persona" required>
        <option value="" disabled selected>Selecione uma persona</option>
        <option value="programador iniciante">Programador iniciante</option>
        <option value="programador experiente">Programador experiente</option>
        <option value="usu√°rio sem conhecimento t√©cnico">Usu√°rio sem conhecimento t√©cnico</option>
        <option value="usu√°rio com conhecimento t√©cnico">Usu√°rio com conhecimento t√©cnico</option>
        <option value="administrador de sistemas">Administrador de sistemas</option>
      </select>

      <label for="api-key">Chave da API OpenAI:</label>
      <div class="api-key-row">
        <input type="password" id="api-key" placeholder="sk-..." autocomplete="off" required />
        <button type="button" id="toggle-key" tabindex="-1" aria-label="Mostrar/ocultar chave">üëÅÔ∏è</button>
        <button type="button" id="save-key" tabindex="-1">Salvar</button>
      </div>

      <button type="submit" id="analyze-btn">Analisar Documento</button>
    </form>
    <div class="loading" id="loading" style="display:none;">Analisando...</div>
    <div class="result" id="result"></div>
  </div>
  <script>
    // Utilit√°rios para PDF
    async function extractTextFromPDF(file) {
      // Usa PDF.js via CDN
      if (!window.pdfjsLib) {
        await new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.min.js';
          script.onload = resolve;
          script.onerror = reject;
          document.head.appendChild(script);
        });
      }
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.worker.min.js';
      const arrayBuffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
      let text = '';
      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        text += content.items.map(item => item.str).join(' ') + '\n';
      }
      return text;
    }

    // LocalStorage para chave da API
    const apiKeyInput = document.getElementById('api-key');
    const saveKeyBtn = document.getElementById('save-key');
    const toggleKeyBtn = document.getElementById('toggle-key');
    const API_KEY_STORAGE = 'openai_api_key_persona';

    function loadApiKey() {
      const key = localStorage.getItem(API_KEY_STORAGE);
      if (key) apiKeyInput.value = key;
    }
    function saveApiKey() {
      if (apiKeyInput.value.startsWith('sk-')) {
        localStorage.setItem(API_KEY_STORAGE, apiKeyInput.value);
        saveKeyBtn.textContent = 'Salvo!';
        setTimeout(() => saveKeyBtn.textContent = 'Salvar', 1200);
      } else {
        alert('Chave inv√°lida. Deve come√ßar com "sk-".');
      }
    }
    function toggleApiKeyVisibility() {
      apiKeyInput.type = apiKeyInput.type === 'password' ? 'text' : 'password';
      toggleKeyBtn.textContent = apiKeyInput.type === 'password' ? 'üëÅÔ∏è' : 'üôà';
    }
    saveKeyBtn.addEventListener('click', saveApiKey);
    toggleKeyBtn.addEventListener('click', toggleApiKeyVisibility);
    loadApiKey();

    // Formul√°rio principal
    const form = document.getElementById('analyzer-form');
    const fileInput = document.getElementById('file');
    const personaSelect = document.getElementById('persona');
    const resultDiv = document.getElementById('result');
    const loadingDiv = document.getElementById('loading');
    const analyzeBtn = document.getElementById('analyze-btn');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      resultDiv.textContent = '';
      loadingDiv.style.display = 'block';
      analyzeBtn.disabled = true;

      const file = fileInput.files[0];
      const persona = personaSelect.value;
      const apiKey = localStorage.getItem(API_KEY_STORAGE);

      if (!file || !persona || !apiKey) {
        loadingDiv.style.display = 'none';
        analyzeBtn.disabled = false;
        alert('Preencha todos os campos e salve a chave da API.');
        return;
      }

      let docText = '';
      try {
        if (file.name.toLowerCase().endsWith('.pdf')) {
          docText = await extractTextFromPDF(file);
        } else {
          docText = await file.text();
        }
      } catch (err) {
        loadingDiv.style.display = 'none';
        analyzeBtn.disabled = false;
        resultDiv.textContent = 'Erro ao ler o documento: ' + err.message;
        return;
      }

      // Prompt conforme instru√ß√£o
      const prompt = `Act as ${persona} trying to use the shared documentation to complete a task.
Yout goal is to behave like a real person.

Tell me if any parts:
- Felt too simple or overly guided.
- Were vague, too basic or missing critical details.
- Could be improved to make the instructions easier to follow.
- Required external help to complete the task.

Be specific and share your suggestions in a structured manner.

Sempre devolva as respostas em PT-BR.

DOCUMENTA√á√ÉO:
${docText}
`;

      // Chamada √† OpenAI
      try {
        const response = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + apiKey
          },
          body: JSON.stringify({
            model: 'gpt-3.5-turbo',
            messages: [
              { role: 'user', content: prompt }
            ],
            temperature: 0.7,
            max_tokens: 1024
          })
        });

        if (!response.ok) {
          throw new Error('Erro na API: ' + response.status + ' ' + response.statusText);
        }
        const data = await response.json();
        const answer = data.choices?.[0]?.message?.content || 'Nenhuma resposta gerada.';
        resultDiv.textContent = answer;
      } catch (err) {
        resultDiv.textContent = 'Erro ao consultar a OpenAI: ' + err.message;
      } finally {
        loadingDiv.style.display = 'none';
        analyzeBtn.disabled = false;
      }
    });

    // Seguran√ßa: nunca expor a chave
    window.addEventListener('beforeunload', () => {
      apiKeyInput.value = '';
    });
  </script>
</body>
</html>
